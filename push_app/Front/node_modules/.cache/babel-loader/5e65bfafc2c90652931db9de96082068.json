{"ast":null,"code":"\"use strict\";\n/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ResourceCollector = void 0;\n/**\n * ResourceCollector class implements asynchronous logic of calling the API call that supports pagination,\n * page by page, collecting all resources (up to `maxResults`) in the array.\n *\n * Usage:\n *   const resourceCollector = new ResourceCollector(apiCall, maxResults); // -1 for unlimited\n *   resourceCollector.processAllPages(request).then(resources => ...);\n */\n\nclass ResourceCollector {\n  constructor(apiCall) {\n    let maxResults = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : -1;\n    this.apiCall = apiCall;\n    this.resources = [];\n    this.maxResults = maxResults;\n  }\n\n  callback(err, resources, nextPageRequest) {\n    var _this = this;\n\n    if (err) {\n      // Something went wrong with this request - failing everything\n      this.rejectCallback(err);\n      return;\n    } // Process one page\n\n\n    for (const resource of resources) {\n      this.resources.push(resource);\n\n      if (this.resources.length === this.maxResults) {\n        nextPageRequest = null;\n        break;\n      }\n    } // All done?\n\n\n    if (!nextPageRequest) {\n      this.resolveCallback(this.resources);\n      return;\n    } // Schedule the next call\n\n\n    const callback = function () {\n      return _this.callback(...arguments);\n    };\n\n    setImmediate(this.apiCall, nextPageRequest, callback);\n  }\n\n  processAllPages(firstRequest) {\n    var _this2 = this;\n\n    return new Promise((resolve, reject) => {\n      this.resolveCallback = resolve;\n      this.rejectCallback = reject; // Schedule the first call\n\n      const callback = function () {\n        return _this2.callback(...arguments);\n      };\n\n      setImmediate(this.apiCall, firstRequest, callback);\n    });\n  }\n\n}\n\nexports.ResourceCollector = ResourceCollector;","map":{"version":3,"mappings":";AAAA;;;;;;;;;;;;;;;;;;;;AAuBA;;;;;;;;;AAQA,MAAaA,iBAAb,CAA8B;AAO5BC,cAAYC,OAAZ,EAA4D;AAAA,QAAfC,UAAe,uEAAF,CAAC,CAAC;AAC1D,SAAKD,OAAL,GAAeA,OAAf;AACA,SAAKE,SAAL,GAAiB,EAAjB;AACA,SAAKD,UAAL,GAAkBA,UAAlB;AACD;;AAEOE,UAAQ,CACdC,GADc,EAEdF,SAFc,EAGdG,eAHc,EAGsB;AAAA;;AAEpC,QAAID,GAAJ,EAAS;AACP;AACA,WAAKE,cAAL,CAAqBF,GAArB;AACA;AACD,KANmC,CAQpC;;;AACA,SAAK,MAAMG,QAAX,IAAuBL,SAAvB,EAAkC;AAChC,WAAKA,SAAL,CAAeM,IAAf,CAAoBD,QAApB;;AACA,UAAI,KAAKL,SAAL,CAAeO,MAAf,KAA0B,KAAKR,UAAnC,EAA+C;AAC7CI,uBAAe,GAAG,IAAlB;AACA;AACD;AACF,KAfmC,CAiBpC;;;AACA,QAAI,CAACA,eAAL,EAAsB;AACpB,WAAKK,eAAL,CAAsB,KAAKR,SAA3B;AACA;AACD,KArBmC,CAuBpC;;;AACA,UAAMC,QAAQ,GAAG;AAAA,aAEZ,KAAI,CAACA,QAAL,CAAc,YAAd,CAFY;AAAA,KAAjB;;AAGAQ,gBAAY,CAAC,KAAKX,OAAN,EAAeK,eAAf,EAAgCF,QAAhC,CAAZ;AACD;;AAEDS,iBAAe,CAACC,YAAD,EAA0B;AAAA;;AACvC,WAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAoB;AACrC,WAAKN,eAAL,GAAuBK,OAAvB;AACA,WAAKT,cAAL,GAAsBU,MAAtB,CAFqC,CAIrC;;AACA,YAAMb,QAAQ,GAAG;AAAA,eAEZ,MAAI,CAACA,QAAL,CAAc,YAAd,CAFY;AAAA,OAAjB;;AAGAQ,kBAAY,CAAC,KAAKX,OAAN,EAAea,YAAf,EAA6BV,QAA7B,CAAZ;AACD,KATM,CAAP;AAUD;;AAzD2B;;AAA9Bc","names":["ResourceCollector","constructor","apiCall","maxResults","resources","callback","err","nextPageRequest","rejectCallback","resource","push","length","resolveCallback","setImmediate","processAllPages","firstRequest","Promise","resolve","reject","exports"],"sources":["../../../src/paginationCalls/resourceCollector.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}